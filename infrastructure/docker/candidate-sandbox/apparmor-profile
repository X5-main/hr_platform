#include <tunables/global>

profile candidate-sandbox flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/bash>
  #include <abstractions/nameservice>
  #include <abstractions/X>

  # Deny dangerous capabilities
  deny capability sys_admin,
  deny capability sys_module,
  deny capability sys_rawio,
  deny capability sys_ptrace,
  deny capability sys_pacct,
  deny capability sys_nice,
  deny capability sys_resource,
  deny capability sys_time,
  deny capability sys_tty_config,
  deny capability audit_control,
  deny capability audit_write,
  deny capability setuid,
  deny capability setgid,
  deny capability net_admin,
  deny capability net_raw,
  deny capability mknod,
  deny capability fsetid,

  # Filesystem restrictions
  / r,
  /** r,

  # Deny write to system directories
  deny /bin/** w,
  deny /sbin/** w,
  deny /usr/bin/** w,
  deny /usr/sbin/** w,
  deny /usr/local/bin/** w,
  deny /lib/** w,
  deny /lib64/** w,
  deny /usr/lib/** w,
  deny /usr/lib64/** w,
  deny /etc/** w,
  deny /opt/** w,

  # Deny access to sensitive kernel interfaces
  deny /proc/sys/** w,
  deny /proc/sysrq-trigger rw,
  deny /proc/kcore rw,
  deny /proc/kmem rw,
  deny /proc/kallsyms r,
  deny /sys/** w,
  deny /sys/firmware/** rw,
  deny /sys/kernel/** rw,

  # Allow workspace writes
  /workspace/** rwk,
  /home/candidate/** rwk,
  /tmp/** rwk,
  /var/tmp/** rwk,
  /var/log/supervisor/** rw,
  /run/** rw,

  # Allow specific executables
  /usr/bin/xvfb ix,
  /usr/bin/x11vnc ix,
  /usr/bin/fluxbox ix,
  /usr/bin/xterm ix,
  /usr/bin/code-server ix,
  /usr/bin/node ix,
  /usr/bin/python3* ix,
  /usr/bin/supervisord ix,
  /usr/bin/supervisorctl ix,
  /usr/local/bin/** ix,
  /opt/noVNC/** ix,

  # Deny execution from writable directories
  deny /home/candidate/Downloads/** x,
  deny /tmp/** x,
  deny /var/tmp/** x,

  # Network access (allowed but logged)
  network inet stream,
  network inet6 stream,
  network inet dgram,
  network inet6 dgram,
  deny network raw,
  deny network packet,

  # Signal permissions
  signal (send, receive) peer=candidate-sandbox,

  # ptrace restrictions
  deny ptrace (read, write, trace),

  # Mount restrictions
  deny mount,
  deny umount,
  deny remount,
}
